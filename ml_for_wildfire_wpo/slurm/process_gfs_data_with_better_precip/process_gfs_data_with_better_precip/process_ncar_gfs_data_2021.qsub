#!/bin/tcsh

#SBATCH --job-name="process_ncar_gfs_data_2021"
#SBATCH --partition="bigmem"
#SBATCH --account="gsd-hpcs"
#SBATCH --qos="batch"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
##SBATCH --nodes=1
##SBATCH --ntasks=1
##SBATCH --cpus-per-task=1
##SBATCH --ntasks-per-node=1
#SBATCH --time=06:00:00
#SBATCH --array=1,7,13,19,25,31,37,43,49,55,61,67,73,79,85,91,97,103,109,115,121,127,133,139,145,151,157,163,169,175,181,187,193,199,205,211,217,223,229,235,241,247,253,259,265,271,277,283,289,295,301,307,313,319,325,331,337,343,349,355,361
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=process_ncar_gfs_data_2021_%A_%a.out

module load cuda/10.1
module load gnu/9.2.0
module load wgrib2/3.1.1_ncep

source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml_for_wildfire_wpo_standalone/ml_for_wildfire_wpo"
set MAIN_INPUT_DIR_NAME="/scratch1/BMC/gsd-hpcs/Ryan.Lagerquist/gfs_data_for_fire_weather/raw_from_ncar/2021"
set INPUT_PRECIP_DIR_NAME="/scratch2/BMC/gsd-hpcs/Ryan.Lagerquist/gfs_data_fwi_inputs_only/grib2"
set OUTPUT_DIR_NAME="/scratch2/BMC/gsd-hpcs/Ryan.Lagerquist/ml_for_wildfire_wpo_project/gfs_data/processed_from_ncar"
set WGRIB2_EXE_NAME="wgrib2"

set DATE_STRINGS=("20210101" "20210102" "20210103" "20210104" "20210105" "20210106" "20210107" "20210108" "20210109" "20210110" "20210111" "20210112" "20210113" "20210114" "20210115" "20210116" "20210117" "20210118" "20210119" "20210120" "20210121" "20210122" "20210123" "20210124" "20210125" "20210126" "20210127" "20210128" "20210129" "20210130" "20210131" "20210201" "20210202" "20210203" "20210204" "20210205" "20210206" "20210207" "20210208" "20210209" "20210210" "20210211" "20210212" "20210213" "20210214" "20210215" "20210216" "20210217" "20210218" "20210219" "20210220" "20210221" "20210222" "20210223" "20210224" "20210225" "20210226" "20210227" "20210228" "20210301" "20210302" "20210303" "20210304" "20210305" "20210306" "20210307" "20210308" "20210309" "20210310" "20210311" "20210312" "20210313" "20210314" "20210315" "20210316" "20210317" "20210318" "20210319" "20210320" "20210321" "20210322" "20210323" "20210324" "20210325" "20210326" "20210327" "20210328" "20210329" "20210330" "20210331" "20210401" "20210402" "20210403" "20210404" "20210405" "20210406" "20210407" "20210408" "20210409" "20210410" "20210411" "20210412" "20210413" "20210414" "20210415" "20210416" "20210417" "20210418" "20210419" "20210420" "20210421" "20210422" "20210423" "20210424" "20210425" "20210426" "20210427" "20210428" "20210429" "20210430" "20210501" "20210502" "20210503" "20210504" "20210505" "20210506" "20210507" "20210508" "20210509" "20210510" "20210511" "20210512" "20210513" "20210514" "20210515" "20210516" "20210517" "20210518" "20210519" "20210520" "20210521" "20210522" "20210523" "20210524" "20210525" "20210526" "20210527" "20210528" "20210529" "20210530" "20210531" "20210601" "20210602" "20210603" "20210604" "20210605" "20210606" "20210607" "20210608" "20210609" "20210610" "20210611" "20210612" "20210613" "20210614" "20210615" "20210616" "20210617" "20210618" "20210619" "20210620" "20210621" "20210622" "20210623" "20210624" "20210625" "20210626" "20210627" "20210628" "20210629" "20210630" "20210701" "20210702" "20210703" "20210704" "20210705" "20210706" "20210707" "20210708" "20210709" "20210710" "20210711" "20210712" "20210713" "20210714" "20210715" "20210716" "20210717" "20210718" "20210719" "20210720" "20210721" "20210722" "20210723" "20210724" "20210725" "20210726" "20210727" "20210728" "20210729" "20210730" "20210731" "20210801" "20210802" "20210803" "20210804" "20210805" "20210806" "20210807" "20210808" "20210809" "20210810" "20210811" "20210812" "20210813" "20210814" "20210815" "20210816" "20210817" "20210818" "20210819" "20210820" "20210821" "20210822" "20210823" "20210824" "20210825" "20210826" "20210827" "20210828" "20210829" "20210830" "20210831" "20210901" "20210902" "20210903" "20210904" "20210905" "20210906" "20210907" "20210908" "20210909" "20210910" "20210911" "20210912" "20210913" "20210914" "20210915" "20210916" "20210917" "20210918" "20210919" "20210920" "20210921" "20210922" "20210923" "20210924" "20210925" "20210926" "20210927" "20210928" "20210929" "20210930" "20211001" "20211002" "20211003" "20211004" "20211005" "20211006" "20211007" "20211008" "20211009" "20211010" "20211011" "20211012" "20211013" "20211014" "20211015" "20211016" "20211017" "20211018" "20211019" "20211020" "20211021" "20211022" "20211023" "20211024" "20211025" "20211026" "20211027" "20211028" "20211029" "20211030" "20211031" "20211101" "20211102" "20211103" "20211104" "20211105" "20211106" "20211107" "20211108" "20211109" "20211110" "20211111" "20211112" "20211113" "20211114" "20211115" "20211116" "20211117" "20211118" "20211119" "20211120" "20211121" "20211122" "20211123" "20211124" "20211125" "20211126" "20211127" "20211128" "20211129" "20211130" "20211201" "20211202" "20211203" "20211204" "20211205" "20211206" "20211207" "20211208" "20211209" "20211210" "20211211" "20211212" "20211213" "20211214" "20211215" "20211216" "20211217" "20211218" "20211219" "20211220" "20211221" "20211222" "20211223" "20211224" "20211225" "20211226" "20211227" "20211228" "20211229" "20211230" "20211231")
set i=$SLURM_ARRAY_TASK_ID

while ($i <= `expr $SLURM_ARRAY_TASK_ID + 5` && $i <= $#DATE_STRINGS)
    set first_date_string="${DATE_STRINGS[$i]}"
    set last_date_string="${DATE_STRINGS[$i]}"
    
    python3 -u "${CODE_DIR_NAME}/process_ncar_gfs_data.py" \
    --main_input_grib2_dir_name="${MAIN_INPUT_DIR_NAME}" \
    --input_grib2_precip_dir_name="${INPUT_PRECIP_DIR_NAME}" \
    --start_date_string="${first_date_string}" \
    --end_date_string="${last_date_string}" \
    --start_latitude_deg_n=10 \
    --end_latitude_deg_n=80 \
    --start_longitude_deg_e=160 \
    --end_longitude_deg_e=-55 \
    --wgrib2_exe_file_name="${WGRIB2_EXE_NAME}" \
    --temporary_dir_name="${OUTPUT_DIR_NAME}/tmp/${first_date_string}-${last_date_string}" \
    --output_zarr_dir_name="${OUTPUT_DIR_NAME}"
    
    @ i = $i + 1
end
