#!/bin/tcsh

#SBATCH --job-name="process_ncar_gfs_data_2022"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="gpu"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
##SBATCH --nodes=1
##SBATCH --ntasks=1
##SBATCH --cpus-per-task=1
##SBATCH --ntasks-per-node=1
#SBATCH --time=06:00:00
#SBATCH --array=1,7,13,19,25,31,37,43,49,55,61,67,73,79,85,91,97,103,109,115,121,127,133,139,145,151,157,163,169,175,181,187,193,199,205,211,217,223,229,235,241,247,253,259,265,271,277,283,289,295,301,307,313,319,325,331,337,343,349,355,361
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=process_ncar_gfs_data_2022_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml_for_wildfire_wpo_standalone/ml_for_wildfire_wpo"
set MAIN_INPUT_DIR_NAME="/scratch1/BMC/gsd-hpcs/Ryan.Lagerquist/gfs_data_for_fire_weather/raw_from_ncar"
set INPUT_PRECIP_DIR_NAME="/scratch2/BMC/gsd-hpcs/Ryan.Lagerquist/gfs_data_fwi_inputs_only/grib2"
set OUTPUT_DIR_NAME="/scratch2/BMC/gsd-hpcs/Ryan.Lagerquist/ml_for_wildfire_wpo_project/gfs_data/processed_from_ncar"
set WGRIB2_EXE_NAME="wgrib2"

set DATE_STRINGS=("20220101" "20220102" "20220103" "20220104" "20220105" "20220106" "20220107" "20220108" "20220109" "20220110" "20220111" "20220112" "20220113" "20220114" "20220115" "20220116" "20220117" "20220118" "20220119" "20220120" "20220121" "20220122" "20220123" "20220124" "20220125" "20220126" "20220127" "20220128" "20220129" "20220130" "20220131" "20220201" "20220202" "20220203" "20220204" "20220205" "20220206" "20220207" "20220208" "20220209" "20220210" "20220211" "20220212" "20220213" "20220214" "20220215" "20220216" "20220217" "20220218" "20220219" "20220220" "20220221" "20220222" "20220223" "20220224" "20220225" "20220226" "20220227" "20220228" "20220301" "20220302" "20220303" "20220304" "20220305" "20220306" "20220307" "20220308" "20220309" "20220310" "20220311" "20220312" "20220313" "20220314" "20220315" "20220316" "20220317" "20220318" "20220319" "20220320" "20220321" "20220322" "20220323" "20220324" "20220325" "20220326" "20220327" "20220328" "20220329" "20220330" "20220331" "20220401" "20220402" "20220403" "20220404" "20220405" "20220406" "20220407" "20220408" "20220409" "20220410" "20220411" "20220412" "20220413" "20220414" "20220415" "20220416" "20220417" "20220418" "20220419" "20220420" "20220421" "20220422" "20220423" "20220424" "20220425" "20220426" "20220427" "20220428" "20220429" "20220430" "20220501" "20220502" "20220503" "20220504" "20220505" "20220506" "20220507" "20220508" "20220509" "20220510" "20220511" "20220512" "20220513" "20220514" "20220515" "20220516" "20220517" "20220518" "20220519" "20220520" "20220521" "20220522" "20220523" "20220524" "20220525" "20220526" "20220527" "20220528" "20220529" "20220530" "20220531" "20220601" "20220602" "20220603" "20220604" "20220605" "20220606" "20220607" "20220608" "20220609" "20220610" "20220611" "20220612" "20220613" "20220614" "20220615" "20220616" "20220617" "20220618" "20220619" "20220620" "20220621" "20220622" "20220623" "20220624" "20220625" "20220626" "20220627" "20220628" "20220629" "20220630" "20220701" "20220702" "20220703" "20220704" "20220705" "20220706" "20220707" "20220708" "20220709" "20220710" "20220711" "20220712" "20220713" "20220714" "20220715" "20220716" "20220717" "20220718" "20220719" "20220720" "20220721" "20220722" "20220723" "20220724" "20220725" "20220726" "20220727" "20220728" "20220729" "20220730" "20220731" "20220801" "20220802" "20220803" "20220804" "20220805" "20220806" "20220807" "20220808" "20220809" "20220810" "20220811" "20220812" "20220813" "20220814" "20220815" "20220816" "20220817" "20220818" "20220819" "20220820" "20220821" "20220822" "20220823" "20220824" "20220825" "20220826" "20220827" "20220828" "20220829" "20220830" "20220831" "20220901" "20220902" "20220903" "20220904" "20220905" "20220906" "20220907" "20220908" "20220909" "20220910" "20220911" "20220912" "20220913" "20220914" "20220915" "20220916" "20220917" "20220918" "20220919" "20220920" "20220921" "20220922" "20220923" "20220924" "20220925" "20220926" "20220927" "20220928" "20220929" "20220930" "20221001" "20221002" "20221003" "20221004" "20221005" "20221006" "20221007" "20221008" "20221009" "20221010" "20221011" "20221012" "20221013" "20221014" "20221015" "20221016" "20221017" "20221018" "20221019" "20221020" "20221021" "20221022" "20221023" "20221024" "20221025" "20221026" "20221027" "20221028" "20221029" "20221030" "20221031" "20221101" "20221102" "20221103" "20221104" "20221105" "20221106" "20221107" "20221108" "20221109" "20221110" "20221111" "20221112" "20221113" "20221114" "20221115" "20221116" "20221117" "20221118" "20221119" "20221120" "20221121" "20221122" "20221123" "20221124" "20221125" "20221126" "20221127" "20221128" "20221129" "20221130" "20221201" "20221202" "20221203" "20221204" "20221205" "20221206" "20221207" "20221208" "20221209" "20221210" "20221211" "20221212" "20221213" "20221214" "20221215" "20221216" "20221217" "20221218" "20221219" "20221220" "20221221" "20221222" "20221223" "20221224" "20221225" "20221226" "20221227" "20221228" "20221229" "20221230" "20221231")
set i=$SLURM_ARRAY_TASK_ID

while ($i <= `expr $SLURM_ARRAY_TASK_ID + 5` && $i <= $#DATE_STRINGS)
    set first_date_string="${DATE_STRINGS[$i]}"
    set last_date_string="${DATE_STRINGS[$i]}"
    
    python3 -u "${CODE_DIR_NAME}/process_ncar_gfs_data.py" \
    --main_input_grib2_dir_name="${MAIN_INPUT_DIR_NAME}" \
    --input_grib2_precip_dir_name="${INPUT_PRECIP_DIR_NAME}" \
    --start_date_string="${first_date_string}" \
    --end_date_string="${last_date_string}" \
    --start_latitude_deg_n=10 \
    --end_latitude_deg_n=80 \
    --start_longitude_deg_e=160 \
    --end_longitude_deg_e=-55 \
    --wgrib2_exe_file_name="${WGRIB2_EXE_NAME}" \
    --temporary_dir_name="${OUTPUT_DIR_NAME}/tmp/${first_date_string}-${last_date_string}" \
    --output_zarr_dir_name="${OUTPUT_DIR_NAME}"
    
    @ i = $i + 1
end
